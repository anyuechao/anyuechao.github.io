<!DOCTYPE html>
<!--[if lte IE 8 ]>
<html class="ie" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<![endif]-->
<!--[if (gte IE 9)|!(IE)]><!-->
<!--
***************  *      *     *
      8          *    *       *
      8          *  *         *
      8          **           *
      8          *  *         *
      8          *    *       *
      8          *      *     *
      8          *        *   ***********    -----Theme By Kieran(http://go.kieran.top)
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
<!--<![endif]-->

<head>
  <title>KVC详解 | 安跃超</title>
  <!-- Meta data -->
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="安跃超">
    <meta name="author" content="YueChao An">
    <meta name="description" content="安跃超的博客" />
    <meta name="keywords" content="" />

    <!-- Favicon, (keep icon in root folder) -->
    <link rel="Shortcut Icon" href="/img/favicon.ico" type="image/ico">

    <link rel="alternate" href="/atom.xml" title="安跃超" type="application/atom+xml">
    <link rel="stylesheet" href="/css/all.css" media="screen" type="text/css">
    
    <link rel="stylesheet" href="/highlightjs/xcode.css" type="text/css">
    

    <!--[if IE 8]>
    <link rel="stylesheet" type="text/css" href="/css/ie8.css" />
    <![endif]-->

    <!-- jQuery | Load our jQuery, with an alternative source fallback to a local version if request is unavailable -->
    <script src="/js/jquery-1.11.1.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/jquery-1.11.1.min.js"><\/script>')</script>

    <!-- Load these in the <head> for quicker IE8+ load times -->
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/js/html5shiv.min.js"></script>
    <script src="/js/respond.min.js"></script>
    <![endif]-->

  
  
  

  <style>.col-md-8.col-md-offset-2.opening-statement img{display:none;}</style>
</head>

<!--
<body class="post-template">
-->
<body id="index" class="lightnav animsition">

      <!-- ============================ Off-canvas navigation =========================== -->

    <div class="sb-slidebar sb-right sb-style-overlay sb-momentum-scrolling">
        <div class="sb-close" aria-label="Close Menu" aria-hidden="true">
            <img src="/img/close.png" alt="Close"/>
        </div>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu">
            <li><a href="/" class="animsition-link" title="Home">Home</a></li>
            <li><a href="/archives" class="animsition-link" title="archive">archives</a></li>
            <!-- Dropdown Menu -->
			 
            
        	<li>
        		<a class="sb-toggle-submenu">Categories<span class="sb-caret"></span></a>
            	<ul class="sb-submenu">
				  	
				    <li><a href="/categories/Nginx-br/" class="animsition-link">Nginx&lt;br&gt;<small>(1)</small></a></li>
				    
				    <li><a href="/categories/Swift-br/" class="animsition-link">Swift &lt;br/&gt;<small>(1)</small></a></li>
				    
				    <li><a href="/categories/UNIX-br/" class="animsition-link">UNIX &lt;br/&gt;<small>(1)</small></a></li>
				    
				    <li><a href="/categories/dart/" class="animsition-link">dart<small>(1)</small></a></li>
				    
				    <li><a href="/categories/github-br/" class="animsition-link">github&lt;br/&gt;<small>(1)</small></a></li>
				    
				    <li><a href="/categories/go-br/" class="animsition-link">go&lt;br&gt;<small>(4)</small></a></li>
				    
				    <li><a href="/categories/go基础/" class="animsition-link">go基础<small>(5)</small></a></li>
				    
				    <li><a href="/categories/hexo-br/" class="animsition-link">hexo&lt;br/&gt;<small>(1)</small></a></li>
				    
				    <li><a href="/categories/iOS/" class="animsition-link">iOS<small>(8)</small></a></li>
				    
				    <li><a href="/categories/iOS-br/" class="animsition-link">iOS &lt;br/&gt;<small>(3)</small></a></li>
				    
				    <li><a href="/categories/iOS-dart/" class="animsition-link">iOS, dart<small>(1)</small></a></li>
				    
				    <li><a href="/categories/iOS-br/" class="animsition-link">iOS&lt;/br&gt;<small>(1)</small></a></li>
				    
				    <li><a href="/categories/iOS-br/" class="animsition-link">iOS&lt;br/&gt;<small>(8)</small></a></li>
				    
				    <li><a href="/categories/iOS-br/" class="animsition-link">iOS&lt;br&gt;<small>(12)</small></a></li>
				    
				    <li><a href="/categories/iOS可视化-br/" class="animsition-link">iOS可视化 &lt;br/&gt;<small>(1)</small></a></li>
				    
				    <li><a href="/categories/python/" class="animsition-link">python<small>(2)</small></a></li>
				    
				    <li><a href="/categories/swift/" class="animsition-link">swift<small>(3)</small></a></li>
				    
				    <li><a href="/categories/swift-br/" class="animsition-link">swift &lt;br/&gt;<small>(1)</small></a></li>
				    
				    <li><a href="/categories/技术篇-br/" class="animsition-link">技术篇 &lt;br/&gt;<small>(1)</small></a></li>
				    
				    <li><a href="/categories/技术篇-br/" class="animsition-link">技术篇&lt;br/&gt;<small>(3)</small></a></li>
				    
				    <li><a href="/categories/编辑工具/" class="animsition-link">编辑工具<small>(1)</small></a></li>
				    
				    <li><a href="/categories/编辑工具-br/" class="animsition-link">编辑工具 &lt;br&gt;<small>(2)</small></a></li>
				    
				    <li><a href="/categories/编辑工具-br/" class="animsition-link">编辑工具&lt;br&gt;<small>(1)</small></a></li>
				    
				    <li><a href="/categories/设计-交互-调研/" class="animsition-link">设计,交互,调研<small>(1)</small></a></li>
				    
				    <li><a href="/categories/调研/" class="animsition-link">调研<small>(1)</small></a></li>
				    
				</ul>
        	</li>
			
            
            <li>
                <a class="sb-toggle-submenu">Links<span class="sb-caret"></span></a>
                <ul class="sb-submenu">
                    
                    <li><a href="http://zhangtianqi.net/" class="animsition-link">zhangtianqi</a></li>
                    
                    <li><a href="http://www.ilakeyc.gift/" class="animsition-link">ilakeyc</a></li>
                    
                    <li><a href="https://github.com/wangshiyu13" class="animsition-link">wangshiyu13</a></li>
                    
                    <li><a href="http://www.lidaze.com/" class="animsition-link">lidaze</a></li>
                    
                    <li><a href="http://liushuang.win/" class="animsition-link">feelShuang</a></li>
                    
                    <li><a href="https://github.com/EmyWong" class="animsition-link">EmyWong</a></li>
                    
                    <li><a href="http://jenko.cc/" class="animsition-link">jenko</a></li>
                    
                    <li><a href="http://liuyanwei.jumppo.com/" class="animsition-link">liuyanwei</a></li>
                    
                    <li><a href="https://github.com/casatwy" class="animsition-link">casatwy</a></li>
                    
                </ul>
            </li>
            
        </ul>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu secondary">
            
            <li><a href="/about.html" class="animsition-link" title="about">About</a></li>
            <li><a href="/atom.xml" class="animsition-link" title="rss">RSS</a></li>
        </ul>
    </div>
    
    <!-- ============================ END Off-canvas navigation =========================== -->

    <!-- ============================ #sb-site Main Page Wrapper =========================== -->

    <div id="sb-site">
        <!-- #sb-site - All page content should be contained within this id, except the off-canvas navigation itself -->

        <!-- ============================ Header & Logo bar =========================== -->

        <div id="navigation" class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <!-- Nav logo -->
                    <div class="logo">
                        <a href="/" title="Logo" class="animsition-link">
                         <img src="/img/logo.png" alt="Logo" width="35px;"/> 
                        </a>
                    </div>
                    <!-- // Nav logo -->
                    <!-- Info-bar -->
                    <nav>
                        <ul class="nav">
                            <li><a href="/" class="animsition-link">安跃超</a></li>
                            <li class="nolink"><span>Always </span>Creative.</li>
                            
                            <li><a href="https://github.com/anyuechao" title="Github" target="_blank"><i class="icon-github"></i></a></li>
                            
                            
                            
                            
                            
                            <li class="nolink"><span>Welcome!</span></li>
                        </ul>
                    </nav>
                    <!--// Info-bar -->
                </div>
                <!-- // .container -->
                <div class="learnmore sb-toggle-right">More</div>
                <button type="button" class="navbar-toggle menu-icon sb-toggle-right" title="More">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar before"></span>
                <span class="icon-bar main"></span>
                <span class="icon-bar after"></span>
                </button>
            </div>
            <!-- // .navbar-inner -->
        </div>

        <!-- ============================ Header & Logo bar =========================== -->


      
<section id="intro">
    <div class="container">
        <div class="row col-md-offset-2">
            <div class="col-md-8">
    			<span class="post-meta">
      <time datetime="2019-09-16T09:12:09.000Z" itemprop="datePublished">
          2019-09-16
      </time>
    
    
    | 
    <a href='/tags/iOS/'>iOS</a>
    
    
</span>
                <h1>KVC详解</h1>
            </div>
        </div>
        <div class="col-md-8 col-md-offset-2">
      		<h3 id="KVC详解"><a href="#KVC详解" class="headerlink" title="KVC详解"></a>KVC详解</h3><h5 id="1-1-前言"><a href="#1-1-前言" class="headerlink" title="1.1 前言"></a>1.1 前言</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在日常的开发中，我们通常会用到KVC进行赋值，或者访问一些私有属性。那么KVC是什么，它的原理又是怎样的？接下来一起去探究分析下。</span><br></pre></td></tr></table></figure>
<h5 id="1-2-何为KVC"><a href="#1-2-何为KVC" class="headerlink" title="1.2 何为KVC"></a>1.2 何为KVC</h5><p>KVC即健值编码，是一种由<code>NSKeyValueCoding</code><a href="https://blog.csdn.net/wzzvictory/article/details/9295317" target="_blank" rel="noopener">非正式协议</a>(非正式协议通俗叫法就是类别，官方这么叫)启用的机制。对象采用该机制来提供对其属性的间接访问。当对象符合键值编码时，其属性可通过字符串参数通过简洁、统一的消息传递接口进行寻址。</p>
<p>键值编码是一个基本概念，它是许多其他 Cocoa 技术的基础，例如 <code>key-value observing</code>, <a href="https://developer.apple.com/library/archive/documentation/General/Devpedia-CocoaApp-MOSX/Bindings.html" target="_blank" rel="noopener">Cocoa bindings</a>, <code>Core Data</code>, and <code>AppleScript-ability</code>。在某些情况下，键值编码还有助于简化您的代码。</p>
<h5 id="1-3-KVC常用的API如下："><a href="#1-3-KVC常用的API如下：" class="headerlink" title="1.3 KVC常用的API如下："></a>1.3 KVC常用的API如下：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">//默认返回YES，表示如果没有找到Set&lt;Key&gt;方法的话，会按照_key，_iskey，key，iskey的顺序搜索成员，设置成NO就不这样搜索</span><br><span class="line">@property (class, readonly) BOOL accessInstanceVariablesDirectly;</span><br><span class="line"></span><br><span class="line">//直接通过Key来取值</span><br><span class="line">- (nullable id)valueForKey:(NSString *)key;</span><br><span class="line"></span><br><span class="line"> //通过Key来设值</span><br><span class="line">- (void)setValue:(nullable id)value forKey:(NSString *)key;</span><br><span class="line"></span><br><span class="line">//通过KeyPath来取值</span><br><span class="line">- (nullable id)valueForKeyPath:(NSString *)keyPath;</span><br><span class="line"></span><br><span class="line">//通过KeyPath来设值</span><br><span class="line">- (void)setValue:(nullable id)value forKeyPath:(NSString *)keyPath;</span><br><span class="line"></span><br><span class="line">//如果Key不存在，且没有KVC无法搜索到任何和Key有关的字段或者属性，则会调用这个方法，默认是抛出异常。</span><br><span class="line">- (nullable id)valueForUndefinedKey:(NSString *)key;</span><br><span class="line"></span><br><span class="line">//和上一个方法一样，但这个方法是设值。</span><br><span class="line">- (void)setValue:(nullable id)value forUndefinedKey:(NSString *)key;</span><br></pre></td></tr></table></figure>
<p>也提供了验证，设置nil的方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//KVC提供属性值正确性验证的API，它可以用来检查set的值是否正确、为不正确的值做一个替换值或者拒绝设置新值并返回错误原因。</span><br><span class="line">- (BOOL)validateValue:(inout id _Nullable * _Nonnull)ioValue forKey:(NSString *)inKey error:(out NSError **)outError;</span><br><span class="line"></span><br><span class="line">- (BOOL)validateValue:(inout id _Nullable * _Nonnull)ioValue forKeyPath:(NSString *)inKeyPath error:(out NSError **)outError;</span><br><span class="line"></span><br><span class="line">//如果你在SetValue方法时面给Value传nil，则会调用这个方法</span><br><span class="line">- (void)setNilValueForKey:(NSString *)key;</span><br></pre></td></tr></table></figure>
<p>数组、字典、集合类型API</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">//这是集合操作的API，里面还有一系列这样的API，如果属性是一个NSMutableArray，那么可以用这个方法来返回。</span><br><span class="line">- (NSMutableArray *)mutableArrayValueForKey:(NSString *)key;</span><br><span class="line"></span><br><span class="line">- (NSMutableOrderedSet *)mutableOrderedSetValueForKey:(NSString *)key API_AVAILABLE(macos(10.7), ios(5.0), watchos(2.0), tvos(9.0));</span><br><span class="line"></span><br><span class="line">- (NSMutableSet *)mutableSetValueForKey:(NSString *)key;</span><br><span class="line"></span><br><span class="line">- (NSMutableArray *)mutableArrayValueForKeyPath:(NSString *)keyPath;</span><br><span class="line"></span><br><span class="line">- (NSMutableOrderedSet *)mutableOrderedSetValueForKeyPath:(NSString *)keyPath API_AVAILABLE(macos(10.7), ios(5.0), watchos(2.0), tvos(9.0));</span><br><span class="line"></span><br><span class="line">- (NSMutableSet *)mutableSetValueForKeyPath:(NSString *)keyPath;</span><br><span class="line"></span><br><span class="line">//输入一组key,返回该组key对应的Value，再转成字典返回，用于将Model转到字典。</span><br><span class="line">- (NSDictionary&lt;NSString *, id&gt; *)dictionaryWithValuesForKeys:(NSArray&lt;NSString *&gt; *)keys;</span><br><span class="line"></span><br><span class="line">- (void)setValuesForKeysWithDictionary:(NSDictionary&lt;NSString *, id&gt; *)keyedValues;</span><br></pre></td></tr></table></figure>
<p>当然这些API都在<code>Foundation</code>框架下NSObject的一个(NSKeyValueCoding)类别里面，其详细的内部实现原理详见<a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/KeyValueCoding/index.html#//apple_ref/doc/uid/10000107i" target="_blank" rel="noopener">官方文档中关于KVC的解释说明</a></p>
<h5 id="1-4-KVC赋值取值的过程"><a href="#1-4-KVC赋值取值的过程" class="headerlink" title="1.4 KVC赋值取值的过程"></a>1.4 KVC赋值取值的过程</h5><h6 id="1-4-1-赋值-setValue-forKey"><a href="#1-4-1-赋值-setValue-forKey" class="headerlink" title="1.4.1 赋值 setValue:forKey:"></a>1.4.1 赋值 <code>setValue:forKey:</code></h6><ul>
<li>按照顺序查找名为<code>set&lt;Key&gt;</code>或者<code>_set&lt;Key&gt;</code>的方法，如果找到就对它赋值。</li>
<li>如果没找到，如果属性 <code>accessInstanceVariablesDirectly</code> 返回值为YES，就会按顺序去找实例变量<code>_&lt;key&gt;</code>,<code>_is&lt;Key&gt;</code>,<code>&lt;key&gt;</code>,或者<code>is&lt;Key&gt;</code>,找到后并对它赋值。</li>
<li>如果没有找到就会走<code>setValue:forUndefinedKey:</code>方法</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/d26baa86c9f64f56abb1ef7b4670d927.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAd2VpeGluXzM3NzM3OTE1,size_20,color_FFFFFF,t_70,g_se,x_16" alt="setValue:forKey:流程图"></p>
<h6 id="1-4-2-取值-valueForKey"><a href="#1-4-2-取值-valueForKey" class="headerlink" title="1.4.2 取值 valueForKey:"></a>1.4.2 取值 <code>valueForKey:</code></h6><ul>
<li>在实例方法中搜索第一个名称为getName、name、isName或_name的访问器方法。如果找到了，就调用它</li>
<li>如果没找到(除去集合类型)，先检验类方法accessInstanceVariablesDirectly实现，并返回YES，然后依次搜索实例变量_name， _isName， name，或isName，如果找到就直接获取实例变量的值并返回</li>
<li>如果没有找到就会走valueForUndefinedKey:方法</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/03f603f2b7b540a9b649d44b2e11cf41.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAd2VpeGluXzM3NzM3OTE1,size_18,color_FFFFFF,t_70,g_se,x_16" alt="valueForKey 流程图"></p>
<h5 id="1-5-自定义KVC"><a href="#1-5-自定义KVC" class="headerlink" title="1.5 自定义KVC"></a>1.5 自定义KVC</h5><h6 id="1-5-1-自定义KVC赋值"><a href="#1-5-1-自定义KVC赋值" class="headerlink" title="1.5.1 自定义KVC赋值"></a>1.5.1 自定义KVC赋值</h6><ul>
<li>先判断key是否存在</li>
<li>再按顺序判断相关的set方法：setName：-&gt;_setName-&gt;setIsName  拼接三个方法的名字，再依次调用 respondsToSelector 方法判断能不能响应，如果能响应就用 performSelector 方法执行调用</li>
<li>如果累方法 accessInstanceVariablesDirectly 返回值为NO，则抛出异常</li>
<li>如果返回值为YES，则先获取类的实例变量名字数组，然后根据相关的实例方法的名字按顺序判断是否在数组中，如果存在就获取实例变量ivar，然后对它赋值。</li>
<li>当实例方法也找不到值时，再抛出异常。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">- (void)yc_setValue:(nullable id)value forKey:(NSString *)key &#123;</span><br><span class="line">    if (key == nil || key.length == 0) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    NSString *Key = key.capitalizedString; //首字母大写</span><br><span class="line">    // 拼接相关的方法名</span><br><span class="line">    NSString *setKey = [NSString stringWithFormat:@&quot;set%@:&quot;,Key];</span><br><span class="line">    NSString *_setKey = [NSString stringWithFormat:@&quot;_set%@:&quot;,Key];</span><br><span class="line">    NSString *setIsKey = [NSString stringWithFormat:@&quot;setIs%@:&quot;,Key];</span><br><span class="line"></span><br><span class="line">    // 按顺序判断是否实现三个实例方法</span><br><span class="line">    if ([self yc_performSelectorWithMethodName:setKey value:value]) &#123;</span><br><span class="line">        NSLog(@&quot;___ %@ ___&quot;,setKey);</span><br><span class="line">        return;</span><br><span class="line">    &#125; else if ([self yc_performSelectorWithMethodName:_setKey value:value]) &#123;</span><br><span class="line">        NSLog(@&quot;___ %@ ___&quot;,_setKey);</span><br><span class="line">        return;</span><br><span class="line">    &#125; else if ([self yc_performSelectorWithMethodName:setIsKey value:value]) &#123;</span><br><span class="line">        NSLog(@&quot;___ %@ ___&quot;,setIsKey);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (![self.class accessInstanceVariablesDirectly] ) &#123;</span><br><span class="line">        @throw [NSException exceptionWithName:@&quot;yc_UnknownKeyException&quot; reason:[NSString stringWithFormat:@&quot;****[%@ valueForUndefinedKey:]: this class is not key value coding-compliant for the key name.****&quot;,self] userInfo:nil];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 获取所有实例变量的名字</span><br><span class="line">    NSMutableArray *mArray = [self getIvarListName];</span><br><span class="line">    // 拼接出需要的实例变量名字</span><br><span class="line">    NSString *_key = [NSString stringWithFormat:@&quot;_%@&quot;,key];</span><br><span class="line">    NSString *_isKey = [NSString stringWithFormat:@&quot;_is%@&quot;,Key];</span><br><span class="line">    NSString *isKey = [NSString stringWithFormat:@&quot;is%@&quot;,Key];</span><br><span class="line"></span><br><span class="line">    // 依次判断拼接的实例变量名字是否在实例变量数组中，存在则获取实例变量并赋值</span><br><span class="line">    if ([mArray containsObject:_key]) &#123;</span><br><span class="line">       Ivar ivar = class_getInstanceVariable([self class], _key.UTF8String);</span><br><span class="line">       object_setIvar(self , ivar, value);</span><br><span class="line">       return;</span><br><span class="line">    &#125; else if ([mArray containsObject:_isKey]) &#123;</span><br><span class="line">       Ivar ivar = class_getInstanceVariable([self class], _isKey.UTF8String);</span><br><span class="line">       object_setIvar(self , ivar, value);</span><br><span class="line">       return;</span><br><span class="line">    &#125; else if ([mArray containsObject:key]) &#123;</span><br><span class="line">       Ivar ivar = class_getInstanceVariable([self class], key.UTF8String);</span><br><span class="line">       object_setIvar(self , ivar, value);</span><br><span class="line">       return;</span><br><span class="line">    &#125; else if ([mArray containsObject:isKey]) &#123;</span><br><span class="line">       Ivar ivar = class_getInstanceVariable([self class], isKey.UTF8String);</span><br><span class="line">       object_setIvar(self , ivar, value);</span><br><span class="line">       return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 如果找不到相关实例变量，就抛出异常</span><br><span class="line">    @throw [NSException exceptionWithName:@&quot;yc_UnknownKeyException&quot; reason:[NSString stringWithFormat:@&quot;****[%@ %@]: this class is not key value coding-compliant for the key name.****&quot;,self, NSStringFromSelector(_cmd)] userInfo:nil];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (BOOL)yc_performSelectorWithMethodName:(NSString *)methodName value:(id)value&#123;</span><br><span class="line">    // 判断方法是否能响应，</span><br><span class="line">    if ([self respondsToSelector:NSSelectorFromString(methodName)]) &#123;</span><br><span class="line">#pragma clang diagnostic push</span><br><span class="line">#pragma clang diagnostic ignored &quot;-Warc-performSelector-leaks&quot;</span><br><span class="line">        // 能响应则调用</span><br><span class="line">        [self performSelector:NSSelectorFromString(methodName) withObject:value];</span><br><span class="line">#pragma clang diagnostic pop</span><br><span class="line">        return YES;</span><br><span class="line">    &#125;</span><br><span class="line">    return NO;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 获取实例变量的名字</span><br><span class="line">- (NSMutableArray *)getIvarListName&#123;</span><br><span class="line">    NSMutableArray *mArray = [NSMutableArray arrayWithCapacity:1];</span><br><span class="line">    unsigned int count = 0;</span><br><span class="line">    Ivar *ivars = class_copyIvarList([self class], &amp;count);</span><br><span class="line">    for (int i = 0; i&lt;count; i++) &#123;</span><br><span class="line">        Ivar ivar = ivars[i];</span><br><span class="line">        const char *ivarNameChar = ivar_getName(ivar);</span><br><span class="line">        NSString *ivarName = [NSString stringWithUTF8String:ivarNameChar];</span><br><span class="line">        NSLog(@&quot;ivarName == %@&quot;,ivarName);</span><br><span class="line">        [mArray addObject:ivarName];</span><br><span class="line">    &#125;</span><br><span class="line">    free(ivars);</span><br><span class="line">    return mArray;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="1-5-2-自定义KVC取值"><a href="#1-5-2-自定义KVC取值" class="headerlink" title="1.5.2 自定义KVC取值"></a>1.5.2 自定义KVC取值</h6><ul>
<li>先判断key是否存在，不存在或者为空时，返回nil</li>
<li>再按顺序判断相关的get实例方法：getName: -&gt; name -&gt; isName -&gt; _name，先拼接出这几个方法的名字，再依次调用respondsToSelector方法判断能不能响应，如果能响应就用performSelector方法执行调用</li>
<li>如果类方法accessInstanceVariablesDirectly返回值为NO，则抛出异常</li>
<li>如果返回YES，则先获取类的实例变量名字数组，然后根据相关实例方法的名字按顺序判断是否在数组中，如果存在就获取实例变量ivar，然后取值</li>
<li>当实例方法也找不到值时，再抛出异常并返回空</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">- (nullable id)yc_valueForKey:(NSString *)key &#123;</span><br><span class="line">    if (key == nil  || key.length == 0) &#123;</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 首字母大写</span><br><span class="line">    NSString *Key = key.capitalizedString;</span><br><span class="line">    // 拼接 方法名字，部分和实例变量名字相同</span><br><span class="line">    NSString *getKey = [NSString stringWithFormat:@&quot;get%@&quot;,Key];</span><br><span class="line">    NSString *isKey = [NSString stringWithFormat:@&quot;is%@&quot;,Key];</span><br><span class="line">    NSString *_key = [NSString stringWithFormat:@&quot;_%@&quot;,key];</span><br><span class="line">    NSString *countOfKey = [NSString stringWithFormat:@&quot;countOf%@&quot;,Key];</span><br><span class="line">    NSString *objectInKeyAtIndex = [NSString stringWithFormat:@&quot;objectIn%@AtIndex:&quot;,Key];</span><br><span class="line"></span><br><span class="line">#pragma clang diagnostic push</span><br><span class="line">#pragma clang diagnostic ignored &quot;-Warc-performSelector-leaks&quot;</span><br><span class="line">    if ([self respondsToSelector:NSSelectorFromString(getKey)]) &#123;</span><br><span class="line">        return [self performSelector:NSSelectorFromString(getKey)];</span><br><span class="line">    &#125; else if ([self respondsToSelector:NSSelectorFromString(key)])&#123;</span><br><span class="line">        return [self performSelector:NSSelectorFromString(key)];</span><br><span class="line">    &#125; else if ([self respondsToSelector:NSSelectorFromString(isKey)]) &#123;</span><br><span class="line">        return [self performSelector:NSSelectorFromString(isKey)];</span><br><span class="line">    &#125; else if ([self respondsToSelector:NSSelectorFromString(_key)]) &#123;</span><br><span class="line">        return [self performSelector:NSSelectorFromString(_key)];</span><br><span class="line">    &#125;</span><br><span class="line">    // 集合类型处理</span><br><span class="line">    else if ([self respondsToSelector:NSSelectorFromString(countOfKey)])&#123;</span><br><span class="line">        if ([self respondsToSelector:NSSelectorFromString(objectInKeyAtIndex)]) &#123;</span><br><span class="line">            int num = (int)[self performSelector:NSSelectorFromString(countOfKey)];</span><br><span class="line">            NSMutableArray *mArray = [NSMutableArray arrayWithCapacity:1];</span><br><span class="line">            for (int i = 0; i&lt;num-1; i++) &#123;</span><br><span class="line">                num = (int)[self performSelector:NSSelectorFromString(countOfKey)];</span><br><span class="line">            &#125;</span><br><span class="line">            for (int j = 0; j&lt;num; j++) &#123;</span><br><span class="line">                id objc = [self performSelector:NSSelectorFromString(objectInKeyAtIndex) withObject:@(num)];</span><br><span class="line">                [mArray addObject:objc];</span><br><span class="line">            &#125;</span><br><span class="line">            return mArray;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">#pragma clang diagnostic pop</span><br><span class="line"></span><br><span class="line">    // 判断是否能够直接赋值实例变量</span><br><span class="line">    if (![self.class accessInstanceVariablesDirectly] ) &#123;</span><br><span class="line">        @throw [NSException exceptionWithName:@&quot;YC_UnknownKeyException&quot; reason:[NSString stringWithFormat:@&quot;****[%@ valueForUndefinedKey:]: this class is not key value coding-compliant for the key name.****&quot;,self] userInfo:nil];</span><br><span class="line">    &#125;</span><br><span class="line">    // 获取实例变量名字</span><br><span class="line">    NSMutableArray *mArray = [self getIvarListName];</span><br><span class="line"></span><br><span class="line">    NSString *_isKey = [NSString stringWithFormat:@&quot;_is%@&quot;,Key];</span><br><span class="line">    // 依次判断拼接的实例变量名字是否在实例变量数组中，存在则获取实例变量并取值</span><br><span class="line">    if ([mArray containsObject:_key]) &#123;</span><br><span class="line">        Ivar ivar = class_getInstanceVariable([self class], _key.UTF8String);</span><br><span class="line">        return object_getIvar(self, ivar);;</span><br><span class="line">    &#125; else if ([mArray containsObject:_isKey]) &#123;</span><br><span class="line">        Ivar ivar = class_getInstanceVariable([self class], _isKey.UTF8String);</span><br><span class="line">        return object_getIvar(self, ivar);;</span><br><span class="line">    &#125; else if ([mArray containsObject:key]) &#123;</span><br><span class="line">        Ivar ivar = class_getInstanceVariable([self class], key.UTF8String);</span><br><span class="line">        return object_getIvar(self, ivar);;</span><br><span class="line">    &#125; else if ([mArray containsObject:isKey]) &#123;</span><br><span class="line">        Ivar ivar = class_getInstanceVariable([self class], isKey.UTF8String);</span><br><span class="line">        return object_getIvar(self, ivar);;</span><br><span class="line">    &#125;</span><br><span class="line">    @throw [NSException exceptionWithName:@&quot;YC_UnknownKeyException&quot; reason:[NSString stringWithFormat:@&quot;****[%@ %@]: this class is not key value coding-compliant for the key name.****&quot;,self, NSStringFromSelector(_cmd)] userInfo:nil];</span><br><span class="line">    return @&quot;&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

            <div class="clearfix"></div>
            <hr class="nogutter">
        </div>
        <nav class="m-pagination col-md-8 col-md-offset-2 col-sm-24" role="pagination">
    
    <a class="pull-left" href="/2020/11/15/swift:dart代码规范/" style="float: left;">
        ← swift/dart代码规范检查工具介绍
    </a>
    
    
    <a class="pull-right" href="/2019/08/16/国外APP交互调研/">
        国外APP交互调研 →
    </a>
    
</nav>

        <div class="col-md-8 col-md-offset-2 col-sm-24"><script type="text/javascript">
  /**
   * 搜狐畅言
   */

  /*
  document.write('<div id="SOHUCS" sid="' + window.location.pathname.slice(1) + '" ></div>');

  window.onload = function () {
    (function () {
      var appid = 'cytXXXX';
      var conf = 'prod_xxxxxxxxxxxxxxxxx';
      var width = window.innerWidth || document.documentElement.clientWidth;
      var loadJs = function (d, a, id) {
        var c = document.getElementsByTagName("head")[0] || document.head || document.documentElement;
        var b = document.createElement("script");
        b.setAttribute("type", "text/javascript");
        b.setAttribute("charset", "UTF-8");
        b.setAttribute("src", d);
        if (id) {
          b.setAttribute("id", id);
        }
        if (typeof a === "function") {
          if (window.attachEvent) {
            b.onreadystatechange = function () {
              var e = b.readyState;
              if (e === "loaded" || e === "complete") {
                b.onreadystatechange = null;
                a()
              }
            }
          } else {
            b.onload = a
          }
        }
        c.appendChild(b)
      };

      loadJs("https://changyan.sohu.com/upload/changyan.js", function () {
        window.changyan.api.config({
          appid: appid,
          conf: conf
        })
      });
    })();
  }
  */

</script>
</div>
    </div>
</section>


      
<!-- ============================ Footer =========================== -->

<footer>
    <div class="container">
            <div class="copy">
                <p>
                    &copy; 2014<script>new Date().getFullYear()>2010&&document.write("-"+new Date().getFullYear());</script>, Content By YueChao An. All Rights Reserved.
                </p>
                <p>Theme By <a href="//go.kieran.top" style="color: #767D84">Kieran</a></p>
            </div>
            <div class="social">
                <ul>
                    
                    <li><a href="https://github.com/anyuechao" title="Github" target="_blank"><i class="icon-github"></i></a>&nbsp;</li>
                    
                    
                    
                    
                    
                </ul>
            </div>
            <div class="clearfix"> </div>
        </div>
</footer>

<!-- ============================ END Footer =========================== -->
      <!-- Load our scripts -->
<!-- Resizable 'on-demand' full-height hero -->
<script type="text/javascript">
    var resizeHero = function () {
        var hero = $(".cover,.heightblock"),
            window1 = $(window);
        hero.css({
            "height": window1.height()
        });
    };

    resizeHero();

    $(window).resize(function () {
        resizeHero();
    });
</script>
<script src="/js/plugins.min.js"></script><!-- Bootstrap core and concatenated plugins always load here -->
<script src="/js/scripts.js"></script><!-- Theme scripts -->


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$('#intro').find('img').each(function(){
  var alt = this.alt;

  if (alt){
    $(this).after('<span class="caption" style="display:none">' + alt + '</span>');
  }

  $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox" rel="gallery" />');
});
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



      
</body>
</html>
